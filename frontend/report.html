<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report an Issue - PublicVision</title>
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/duplicates.css">
    <link rel="stylesheet" href="css/categories.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand">
                <a href="index.html">
                    <h1>PublicVision</h1>
                </a>
            </div>
            <div class="navbar-menu" id="navbarMenu">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="complaints.html">Complaints</a></li>
                    <li><a href="statistics.html">Statistics</a></li>
                    <li><a href="about.html">About</a></li>
                    <li class="login-signup">
                        <a href="login.html" id="loginBtn" class="btn btn-outline">Login</a>
                        <a href="register.html" id="registerBtn" class="btn btn-primary">Sign Up</a>
                        <div class="user-menu hide" id="userMenu">
                            <div class="notification-bell" id="notificationBell">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                                
                                <!-- Notification Dropdown -->
                                <div class="notification-dropdown" id="notificationDropdown">
                                    <div class="notification-header">
                                        <h3>Notifications</h3>
                                        <button id="markAllReadBtn" class="mark-all-read">Mark all as read</button>
                                    </div>
                                    <ul class="notification-list" id="notificationList">
                                        <!-- Notifications will be populated via JavaScript -->
                                    </ul>
                                </div>
                            </div>
                            <a href="dashboard.html" class="btn btn-outline">Dashboard</a>
                            <a href="#" id="logoutBtn" class="btn btn-primary">Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="navbar-toggle" id="navbarToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="complaint-form-section">
        <div class="container">
            <h1 class="section-title">Report an Issue</h1>
            <div class="form-container">
                <form id="complaintForm" class="complaint-form">
                    <div class="form-group">
                        <label for="title">Title / Summary of Issue*</label>
                        <input type="text" id="title" name="title" required placeholder="Brief description of the issue">
                    </div>

                    <div class="form-group">
                        <label for="description">Detailed Description*</label>
                        <textarea id="description" name="description" rows="4" required placeholder="Please provide details about the issue..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Category*</label> <small>(Click to select one)</small>
                        <div class="category-container">
                            <div class="category-grid" id="categoryGrid">
                                <div class="category-item" onclick="selectCategory(this, 'ROADS')">
                                    <i class="fas fa-road"></i>
                                    <span>Roads</span>
                                </div>
                                <div class="category-item" onclick="selectCategory(this, 'WATER')">
                                    <i class="fas fa-tint"></i>
                                    <span>Water</span>
                                </div>
                                <div class="category-item" onclick="selectCategory(this, 'ELECTRICITY')">
                                    <i class="fas fa-bolt"></i>
                                    <span>Electricity</span>
                                </div>
                                <div class="category-item" onclick="selectCategory(this, 'SANITATION')">
                                    <i class="fas fa-trash"></i>
                                    <span>Sanitation</span>
                                </div>
                                <div class="category-item" onclick="selectCategory(this, 'PUBLIC_PROPERTY')">
                                    <i class="fas fa-building"></i>
                                    <span>Public Property</span>
                                </div>
                                <div class="category-item" onclick="selectCategory(this, 'TRAFFIC')">
                                    <i class="fas fa-traffic-light"></i>
                                    <span>Traffic</span>
                                </div>
                                <div class="category-item" onclick="selectCategory(this, 'STREET_LIGHTS')">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>Street Lights</span>
                                </div>
                                <div class="category-item" onclick="selectCategory(this, 'OTHER')">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Other</span>
                                </div>
                            </div>
                            <input type="hidden" id="category" name="category" required>
                            <div id="selectedCategory" class="selected-category-display">
                                <span>Selected: </span><strong>None</strong>
                            </div>
                            <small id="categoryError" class="error-text"></small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="locationDescription">Location Description*</label>
                            <input type="text" id="locationDescription" name="locationDescription" required placeholder="e.g., Near City Hall, Main Street intersection">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Select Location on Map*</label>
                        <p class="map-help">Click on the map to select the location or use the 'Get My Location' button</p>
                        <button type="button" id="getLocationBtn" class="btn btn-outline">
                            <i class="fas fa-location-arrow"></i> Get My Location
                        </button>
                        <div id="mapContainer" class="map-container"></div>
                        <input type="hidden" id="latitude" name="latitude" required>
                        <input type="hidden" id="longitude" name="longitude" required>
                        <small id="locationError" class="error-text"></small>
                    </div>

                    <div class="form-group">
                        <label for="photoInput">Upload Photos (Optional)</label>
                        <p class="hint-text">You can upload up to 3 images (Max 5MB each)</p>
                        <div class="file-upload-container">
                            <input type="file" id="photoInput" name="photos" accept="image/*" multiple class="file-input">
                            <label for="photoInput" class="file-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <span>Choose Files</span>
                            </label>
                        </div>
                        <div id="photoPreviewContainer" class="photo-preview-container"></div>
                        <small id="photoError" class="error-text"></small>
                    </div>

                    <div id="duplicateWarningContainer" style="display: none;" class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="duplicateWarningText">Similar complaints have been found in the same area.</span>
                        <button type="button" id="viewSimilarBtn" class="btn btn-outline btn-sm">View Similar</button>
                    </div>

                    <div class="form-actions">
                        <button type="submit" id="submitComplaintBtn" class="btn btn-primary">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Duplicate Warning Modal -->
    <div id="include-duplicate-warning-modal"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>PublicVision</h3>
                    <p>A platform for citizens to report and track civic issues in their community.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="complaints.html">Complaints</a></li>
                        <li><a href="statistics.html">Statistics</a></li>
                        <li><a href="about.html">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <ul>
                        <li><i class="fas fa-envelope"></i> info@publicvision.org</li>
                        <li><i class="fas fa-phone"></i> +1 (555) 123-4567</li>
                        <li><a href="contact.html"><i class="fas fa-message"></i> Contact Form</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Follow Us</h3>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 PublicVision. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Remove incorrect attempt to include HTML as JS; modal will be fetched dynamically -->

    <!-- JavaScript Files -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/duplicate-detection.js"></script>
    <script>
        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure auth initialized; initAuth is attached in auth.js DOMContentLoaded too
            if (typeof requireAuth === 'function') {
                requireAuth();
            }
            initializeMap();
            setupFormValidation();
            setupCategorySelection();
            setupPhotoUpload();
            checkForDuplicates();
            loadDuplicateWarningModal();
        });

        // Map initialization
        function initializeMap() {
            const mapContainer = document.getElementById('mapContainer');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }
            // Ensure visible height
            if (!mapContainer.style.height) {
                mapContainer.style.height = '300px';
            }
            const map = L.map(mapContainer).setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            let marker = L.marker([20.5937, 78.9629]).addTo(map);
            latitudeInput.value = 20.5937; longitudeInput.value = 78.9629;
            function setMarker(lat, lng) {
                marker.setLatLng([lat, lng]);
                map.setView([lat, lng], 15);
                latitudeInput.value = lat;
                longitudeInput.value = lng;
            }
            map.on('click', e => setMarker(e.latlng.lat, e.latlng.lng));
            const locateBtn = document.getElementById('getLocationBtn');
            if (locateBtn) {
                locateBtn.addEventListener('click', () => {
                    if (!navigator.geolocation) {
                        document.getElementById('locationError').textContent = 'Geolocation not supported.';
                        return;
                    }
                    locateBtn.disabled = true; locateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
                    navigator.geolocation.getCurrentPosition(pos => {
                        setMarker(pos.coords.latitude, pos.coords.longitude);
                        document.getElementById('locationError').textContent = '';
                        locateBtn.disabled = false; locateBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Get My Location';
                    }, err => {
                        document.getElementById('locationError').textContent = 'Unable to retrieve your location.';
                        locateBtn.disabled = false; locateBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Get My Location';
                        console.error('Geolocation error', err);
                    });
                });
            }
        }

        // Setup form validation
        function setupFormValidation() {
            const form = document.getElementById('complaintForm');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Basic validation
                const title = document.getElementById('title').value.trim();
                const description = document.getElementById('description').value.trim();
                const category = document.getElementById('category').value.trim();
                const latitude = document.getElementById('latitude').value.trim();
                const longitude = document.getElementById('longitude').value.trim();

                let isValid = true;

                if (!title) {
                    isValid = false;
                    showError('title', 'Title is required');
                }

                if (!description) {
                    isValid = false;
                    showError('description', 'Description is required');
                }

                if (!category) {
                    isValid = false;
                    document.getElementById('categoryError').textContent = 'Please select a category';
                    document.getElementById('categoryGrid').style.border = '2px solid #e74c3c';
                    document.getElementById('categoryGrid').style.borderRadius = '5px';
                }

                if (!latitude || !longitude) {
                    isValid = false;
                    document.getElementById('locationError').textContent = 'Please select a location on the map';
                }

                if (isValid) {
                    submitComplaint();
                }
            });
        }

        // Show error for a field
        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            field.classList.add('error');
            
            // Create or update error message
            let errorElement = field.nextElementSibling;
            if (!errorElement || !errorElement.classList.contains('error-text')) {
                errorElement = document.createElement('small');
                errorElement.classList.add('error-text');
                field.parentNode.insertBefore(errorElement, field.nextSibling);
            }
            errorElement.textContent = message;
        }

        // Global function to handle category selection
        function selectCategory(element, categoryValue) {
            const categoryInput = document.getElementById('category');
            const selectedCategoryDisplay = document.getElementById('selectedCategory');
            const categoryError = document.getElementById('categoryError');
            const categoryItems = document.querySelectorAll('.category-item');
            
            // Remove selected class from all items
            categoryItems.forEach(item => {
                item.classList.remove('selected');
                item.style.border = '1px solid #ddd';
                item.style.backgroundColor = '#f8f9fa';
            });
            
            // Add selected class to clicked item
            element.classList.add('selected');
            element.style.border = '2px solid #3498db';
            element.style.backgroundColor = '#e3f2fd';
            
            // Set hidden input value
            categoryInput.value = categoryValue;
            
            // Update the display text
            const categoryName = element.querySelector('span').textContent;
            selectedCategoryDisplay.innerHTML = '<span>Selected: </span><strong>' + categoryName + '</strong>';
            selectedCategoryDisplay.style.display = 'block';
            
            // Clear any previous error
            categoryError.textContent = '';
            
            // Reset border if there was an error
            document.getElementById('categoryGrid').style.borderColor = '';
            document.getElementById('categoryGrid').style.borderWidth = '';
        }
        
        // Setup category selection - now just for initialization
        function setupCategorySelection() {
            // Make sure all category items have pointer cursor
            const categoryItems = document.querySelectorAll('.category-item');
            categoryItems.forEach(item => {
                item.style.cursor = 'pointer';
            });
        }

        // Setup photo upload
        function setupPhotoUpload() {
            const photoInput = document.getElementById('photoInput');
            const previewContainer = document.getElementById('photoPreviewContainer');
            const errorText = document.getElementById('photoError');
            
            photoInput.addEventListener('change', function() {
                // Clear previous previews
                previewContainer.innerHTML = '';
                errorText.textContent = '';
                
                if (this.files.length > 3) {
                    errorText.textContent = 'You can upload a maximum of 3 photos.';
                    this.value = '';
                    return;
                }
                
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    
                    // Check file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        errorText.textContent = 'One or more files exceed the 5MB limit.';
                        this.value = '';
                        previewContainer.innerHTML = '';
                        return;
                    }
                    
                    // Create preview
                    const previewItem = document.createElement('div');
                    previewItem.className = 'photo-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-photo';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.onclick = function() {
                        // Remove the preview and update the FileList
                        previewItem.remove();
                        // Note: Unfortunately, we cannot directly modify the FileList
                        // To properly implement file removal, we'd need to create a custom file handling approach
                    };
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    previewContainer.appendChild(previewItem);
                }
            });
        }

        // Submit the complaint
        function submitComplaint() {
            const form = document.getElementById('complaintForm');
            const submitBtn = document.getElementById('submitComplaintBtn');
            
            // Additional validation for real data
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value.trim();
            const locationLat = parseFloat(document.getElementById('latitude').value.trim());
            const locationLng = parseFloat(document.getElementById('longitude').value.trim());
            const locationDescription = document.getElementById('locationDescription').value.trim();
            
            // Enhanced validation for real data
            let isValid = true;
            
            if (title.length < 10) {
                showError('title', 'Title should be at least 10 characters to be descriptive');
                isValid = false;
            }
            
            if (description.length < 20) {
                showError('description', 'Please provide a more detailed description (minimum 20 characters)');
                isValid = false;
            }
            
            if (locationDescription.length < 10) {
                showError('locationDescription', 'Please provide a more specific location description');
                isValid = false;
            }
            
            if (!isValid) {
                return;
            }
            
            // Disable button to prevent multiple submissions
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            // Create complaint data object with real data validation
            const complaintData = {
                title: title,
                description: description,
                category: category,
                locationLat: locationLat,
                locationLng: locationLng,
                address: locationDescription
            };
            
            // Log the real data being submitted
            console.log('Submitting real complaint data:', complaintData);
            
            // Create form data for multipart request
            const formData = new FormData();
            
            // Add complaint data as a JSON part
            const complaintBlob = new Blob([JSON.stringify(complaintData)], {
                type: 'application/json'
            });
            formData.append('complaint', complaintBlob, 'complaint.json');
            
            // Add images if available - real photos from user
            const photoInput = document.getElementById('photoInput');
            if (photoInput.files && photoInput.files.length > 0) {
                for (let i = 0; i < photoInput.files.length; i++) {
                    formData.append('images', photoInput.files[i]);
                }
            }
            
            // Add user token for authentication
            const token = localStorage.getItem('token');
            
            // Send API request with real data
            fetch(API_CONFIG.baseUrl + '/complaints/create', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to submit complaint');
                }
                return response.json();
            })
            .then(data => {
                // Success - redirect to the detail page for the new complaint
                window.location.href = `complaint-detail.html?id=${data.id}&new=true`;
            })
            .catch(error => {
                alert('Error submitting complaint: ' + error.message);
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Report';
            });
        }

        // Check for duplicate complaints
        function checkForDuplicates() {
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const warningContainer = document.getElementById('duplicateWarningContainer');
            
            // Debounce function to avoid too many API calls
            let debounceTimeout;
            
            function checkDuplicates() {
                const title = titleInput.value.trim();
                const description = descriptionInput.value.trim();
                const latitude = latitudeInput.value.trim();
                const longitude = longitudeInput.value.trim();
                
                // Only check if we have all the necessary data
                if (title && description && latitude && longitude) {
                    checkForDuplicateComplaints(title, description, latitude, longitude)
                        .then(duplicates => {
                            if (duplicates && duplicates.length > 0) {
                                warningContainer.style.display = 'flex';
                                setupDuplicateWarning(duplicates);
                            } else {
                                warningContainer.style.display = 'none';
                            }
                        });
                }
            }
            
            // Listen for changes
            [titleInput, descriptionInput, latitudeInput, longitudeInput].forEach(input => {
                input.addEventListener('change', function() {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(checkDuplicates, 1000);
                });
            });
            
            // Setup view similar button
            document.getElementById('viewSimilarBtn').addEventListener('click', function() {
                document.getElementById('duplicateWarningModal').style.display = 'flex';
            });
        }

        // Load the duplicate warning modal component
        function loadDuplicateWarningModal() {
            fetch('components/duplicate-warning-modal.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('include-duplicate-warning-modal').innerHTML = html;
                });
        }
    </script>
</body>
</html>